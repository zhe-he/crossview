/*
*Crossview
*by:    jiajunyu、zhe-he
*email: junyu@jiaju.com、hezhe@jiaju.com
*version:   1.0
*last-time: 2015-7-23
*参数说明
        bigImg:  '大图img',
        smallBox:   '盒子ul',
        left:   '左箭头',
        right:  '右箭头',
        pre:    '上一页',
        next:   '下一页',
        activeClass:    '活动的active',
        animate:    '运动时间',
        num:        '展示的li的个数',
        afterFn:    function (){
            //运动后的回调函数    
        },
        beforeFn:   function (){
            //运动前的回调函数
        }
*
*
*
*

*/(function(c){function e(a,b){this.bigImg=c(a).find(b.bigImg);this.smallBox=c(a).find(b.smallBox);this.left=c(a).find(b.left);this.right=c(a).find(b.right);this.pre=c(a).find(b.pre);this.next=c(a).find(b.next);this.activeClass=b.activeClass||"active";this.animate=b.animate||500;this.num=b.num||5;this.supportState="pushState"in window.history;this.afterFn=b.afterFn;this.beforeFn=b.beforeFn;this.state={title:document.title,url:window.location.href};this._init();this.init()}c.tools=c.tools||{version:"1.0"};c.tools.Crossview={bigImg:"",smallBox:"",left:"",right:"",pre:"",next:"",activeClass:"active",animate:500,num:5,afterFn:function(){},beforeFn:function(){}};e.prototype={constructor:e,_init:function(){var a=this;this.aLi=this.smallBox.find("li");this.aB=this.smallBox.find("li b");this.aImg=this.smallBox.find("li img");this.count=this.aLi.length;this.now=0;this.w=this.aLi.eq(0).outerWidth(!0);this.smallBox.css("width",this.w*this.count+"px");this.set();this.aLi.removeClass(this.activeClass).eq(this.now).addClass(this.activeClass);this.aLi.each(function(b,d){c(d).on("click",function(){a.click.call(a,b)})})},init:function(){delete this.init;var a=this;this.left.on("click",function(){a._left.call(a)});this.right.on("click",function(){a._right.call(a)});this.hash();c(window).on("hashchange",function(){a.hash()});c(window).on("keyup",function(b){a.keyup.call(a,b)});this.pre.on("click",function(){a._pre.call(a)});this.next.on("click",function(){a._next.call(a)})},set:function(){var a=this;1<this.count&&this.aB.each(function(b,d){c(d).html(b+1+"/"+a.count)})},hash:function(){var a=window.location.hash.substr(1);if(a){a=a.split("\x3d");"page"===a[0]&&(a=Number(a[1]));if(isNaN(a)||a>this.count)a=1;this.click(a)}},keyup:function(a){a=a||window.event;switch(a.keyCode){case 37:this._left();break;case 39:this._right()}},click:function(a){this.now!==a&&(null!=a&&(this.now=a),window.location.hash="#page\x3d"+this.now,this.changeBigImg(this.aImg.eq(this.now)),this.aLi.removeClass(this.activeClass).eq(this.now).addClass(this.activeClass),this.num>=this.count||(a=Math.ceil(this.num/2,10),a=this.now+1-a,0>=a&&(a=0),a>=this.count-this.num&&(a=this.count-this.num),this.smallBox.stop().animate({left:-a*this.w+"px"},this.animate)))},changeBigImg:function(a){var b=this,c=a.attr("_src")||a.attr("src");this.beforeFn&&this.beforeFn();this.bigImg.stop().animate({opacity:0},this.animate,function(){b.bigImg.attr("src",c);b.bigImg.stop().animate({opacity:1},b.animate,function(){b.afterFn&&b.afterFn()})})},_left:function(){this.now--; -1===this.now?(this.now=0,this._pre()):this.click()},_right:function(){this.now++;this.now===this.count?(this.now=this.count-1,this._next()):this.click()},_pre:function(){this.state={title:document.title,url:this.pre.attr("_href")};this.changeUrl(-1)},_next:function(){this.state={title:document.title,url:this.next.attr("_href")};this.changeUrl(1)},changeUrl:function(a){if(this.supportState){var b=this,d=this.pre.find("img"),e=this.next.find("img");if(-1===a){if("javascript:;"===this.pre.attr("_href"))return"\u6ca1\u6709\u4e0a\u4e00\u9875\u4e86";var g=this.pre.attr("_api_href");this.changeBigImg(d)}else if(1===a){if("javascript:;"===this.next.attr("_href"))return"\u6ca1\u6709\u4e0b\u4e00\u9875\u4e86";g=this.next.attr("_api_href");this.changeBigImg(e)}c.ajax({url:g,dataType:"json",success:function(a){if("0"==a.flag)return a.data;if(a.cur.img&&a.cur.img.length){for(var c=[],f=0;f<a.cur.img.length;f++)c[f]=['\x3cli\x3e\x3ca href\x3d"javascript:;"\x3e\x3cimg src\x3d"',a.cur.img[f],'" alt\x3d""/\x3e\x3c/a\x3e\x3cb\x3e\x3c/b\x3e\x3c/li\x3e'],c[f]=c[f].join("");c=c.join("")}else var c='\x3cli\x3e\x3ca href\x3d"javascript:;"\x3e\x3cimg src\x3d"http://static.jiaju.com/jiaju/com/images/shafa/none.jpg" alt\x3d""/\x3e\x3c/a\x3e\x3cb\x3e\x3c/b\x3e\x3c/li\x3e';b.smallBox.empty();b.smallBox.html(c);a.next&&0!==a.next.length?(b.next.attr({_href:a.next.url,_api_href:a.next.api_url}),e.attr({src:a.next.img||"http://static.jiaju.com/jiaju/com/images/shafa/none.jpg",alt:a.next.name})):(b.next.attr({_href:"javascript:;",_api_href:"javascript:;"}),e.attr({src:"http://static.jiaju.com/jiaju/com/images/shafa/none_s.jpg",alt:"\u6ca1\u6709\u66f4\u591a\u4e86"}));a.pre&&0!==a.pre.length?(b.pre.attr({_href:a.pre.url,_api_href:a.pre.api_url}),d.attr({src:a.pre.img||"http://static.jiaju.com/jiaju/com/images/shafa/none.jpg",alt:a.pre.name})):(b.pre.attr({_href:"javascript:;",_api_href:"javascript:;"}),d.attr({src:"http://static.jiaju.com/jiaju/com/images/shafa/none_s.jpg",alt:"\u6ca1\u6709\u66f4\u591a\u4e86"}));window.history.pushState(b.state,"",b.state.url);b._init()}})}else this.state.url&&(window.location.href=this.state.url)}};c.fn.Crossview=function(a){return this.each(function(b,d){c(this).data("Crossview",new e(d,a))})}})(jQuery);